<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil - ERP Génie Civil</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <style>
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes slideIn {
            0% { transform: translateX(-100%); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .floating { animation: float 6s ease-in-out infinite; }
        .slide-in { animation: slideIn 0.8s ease-out; }
        .loading { animation: pulse 1.5s ease-in-out infinite; }
        
        .profile-card-light {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .profile-card-dark {
            background: linear-gradient(135deg, #4c1d95 0%, #581c87 100%);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        
        .theme-transition {
            transition: all 0.3s ease;
        }

        .fa-spin-custom {
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .profile-picture-container {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto;
        }

        .profile-picture {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid rgba(255, 255, 255, 0.3);
        }

        .upload-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            cursor: pointer;
        }

        .profile-picture-container:hover .upload-overlay {
            opacity: 1;
        }
    </style>
</head>
<body class="theme-transition min-h-screen bg-gray-50 dark:bg-gray-900">
    <!-- Navigation Bar -->
    <nav class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <div class="w-10 h-10 bg-orange-500 rounded-full flex items-center justify-center">
                        <i class="fas fa-user text-white text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-gray-900 dark:text-white font-bold text-xl">ERP Génie Civil</h1>
                        <p class="text-gray-600 dark:text-gray-400 text-sm">Mon Profil</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <!-- Back to Dashboard -->
                    <button id="backToDashboard" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-all duration-300">
                        <i class="fas fa-arrow-left mr-2"></i>Tableau de bord
                    </button>
                    
                    <!-- Dark Mode Toggle -->
                    <button id="darkModeToggle" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                        <i id="sunIcon" class="fas fa-sun w-5 h-5 text-gray-600 dark:text-gray-300 hidden dark:block"></i>
                        <i id="moonIcon" class="fas fa-moon w-5 h-5 text-gray-600 dark:text-gray-300 block dark:hidden"></i>
                    </button>
                    
                    <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-all duration-300 transform hover:scale-105">
                        <i class="fas fa-sign-out-alt mr-2"></i>Déconnexion
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Loading State -->
        <div id="loadingState" class="text-center py-12">
            <i class="fas fa-spinner fa-spin-custom text-orange-500 text-6xl"></i>
            <p class="text-gray-600 dark:text-gray-400 mt-4">Chargement du profil...</p>
        </div>

        <!-- Main Content -->
        <div id="mainContent" class="hidden">
            <!-- Profile Header Card -->
            <div class="mb-8 slide-in">
                <div class="profile-card-light dark:profile-card-dark rounded-2xl p-8 text-white shadow-2xl floating">
                    <div class="text-center">
                        <div class="profile-picture-container mb-4">
                            <img id="profilePicture" src="" alt="Photo de profil" class="profile-picture" style="display: none;">
                            <div id="defaultAvatar" class="profile-picture bg-white/20 flex items-center justify-center">
                                <i class="fas fa-user text-6xl text-white/70"></i>
                            </div>
                            <div class="upload-overlay" onclick="document.getElementById('profilePictureInput').click()">
                                <i class="fas fa-camera text-white text-2xl"></i>
                            </div>
                            <input type="file" id="profilePictureInput" accept="image/*" style="display: none;">
                        </div>
                        <h2 class="text-3xl font-bold mb-2" id="profileUsername">Nom d'utilisateur</h2>
                        <p class="text-white/80 text-lg mb-2" id="profileGroup">Rôle</p>
                        <div class="flex items-center justify-center space-x-2">
                            <span id="statusBadge" class="px-3 py-1 bg-green-500/20 text-green-300 rounded-full text-sm">
                                <i class="fas fa-check-circle mr-1"></i>Actif
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Information Card -->
            <div class="slide-in">
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <h3 class="text-2xl font-bold text-gray-900 dark:text-white">
                                <i class="fas fa-user-edit mr-3 text-orange-500"></i>Informations du profil
                            </h3>
                            <button id="editProfileBtn" class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-2 rounded-lg transition-all duration-300 transform hover:scale-105">
                                <i class="fas fa-edit mr-2"></i>Modifier
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <form id="profileForm">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Username -->
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        <i class="fas fa-user mr-2 text-orange-500"></i>Nom d'utilisateur
                                    </label>
                                    <input type="text" id="usernameInput" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-orange-500 dark:bg-gray-700 dark:text-white bg-gray-50 dark:bg-gray-700" readonly>
                                </div>

                                <!-- User ID (Read-only) -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        <i class="fas fa-id-badge mr-2 text-orange-500"></i>ID Utilisateur
                                    </label>
                                    <input type="text" id="userIdInput" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-white cursor-not-allowed" readonly>
                                </div>

                                <!-- Group (Read-only) -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        <i class="fas fa-users mr-2 text-orange-500"></i>Rôle
                                    </label>
                                    <input type="text" id="groupInput" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-white cursor-not-allowed" readonly>
                                </div>

                                <!-- Status (Read-only) -->
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        <i class="fas fa-toggle-on mr-2 text-orange-500"></i>Statut du compte
                                    </label>
                                    <div class="flex items-center space-x-3">
                                        <span id="statusIndicator" class="w-3 h-3 bg-green-500 rounded-full"></span>
                                        <span id="statusText" class="text-gray-900 dark:text-white">Compte actif</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                                <div class="flex justify-end space-x-4" id="actionButtons" style="display: none;">
                                    <button type="button" id="cancelBtn" class="px-6 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 transition-colors">
                                        <i class="fas fa-times mr-1"></i>Annuler
                                    </button>
                                    <button type="submit" class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-2 rounded-lg transition-all duration-300 transform hover:scale-105">
                                        <i class="fas fa-save mr-2"></i>Enregistrer les modifications
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Toast -->
    <div id="errorToast" class="fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg hidden z-50">
        <div class="flex items-center">
            <i class="fas fa-exclamation-circle mr-2"></i>
            <span id="errorMessage">Une erreur s'est produite</span>
        </div>
    </div>

    <!-- Success Toast -->
    <div id="successToast" class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg hidden z-50">
        <div class="flex items-center">
            <i class="fas fa-check-circle mr-2"></i>
            <span id="successMessage">Opération réussie</span>
        </div>
    </div>

    <script>
        // Dark Mode Toggle
        const darkModeToggle = document.getElementById('darkModeToggle');
        const html = document.documentElement;

        const currentTheme = localStorage.getItem('theme') || 'light';
        if (currentTheme === 'dark') {
            html.classList.add('dark');
        }

        darkModeToggle.addEventListener('click', function() {
            html.classList.toggle('dark');
            
            if (html.classList.contains('dark')) {
                localStorage.setItem('theme', 'dark');
            } else {
                localStorage.setItem('theme', 'light');
            }
        });

        // API Configuration
        const API_BASE_URL = 'http://127.0.0.1:8000';
        let isEditing = false;
        let currentUserData = null;

        // Utility Functions
        function showError(message) {
            const errorToast = document.getElementById('errorToast');
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            errorToast.classList.remove('hidden');
            setTimeout(() => {
                errorToast.classList.add('hidden');
            }, 5000);
        }

        function showSuccess(message) {
            const successToast = document.getElementById('successToast');
            const successMessage = document.getElementById('successMessage');
            successMessage.textContent = message;
            successToast.classList.remove('hidden');
            setTimeout(() => {
                successToast.classList.add('hidden');
            }, 3000);
        }

        async function makeAuthenticatedRequest(url, options = {}) {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = 'login.html';
                return null;
            }
            
            const defaultOptions = {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    ...options.headers
                }
            };
            
            const response = await fetch(url, { ...options, ...defaultOptions });
            
            if (response.status === 401) {
                localStorage.clear();
                window.location.href = 'login.html';
                return null;
            }
            
            return response;
        }

        function checkAuthentication() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        // Load Profile Data
        async function loadProfile() {
            try {
                const response = await makeAuthenticatedRequest(`${API_BASE_URL}/auth/profile/`);
                if (response && response.ok) {
                    currentUserData = await response.json();
                    displayProfile(currentUserData);
                } else {
                    showError('Erreur lors du chargement du profil');
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                showError('Erreur lors du chargement du profil');
            }
        }

        // Display Profile Data
        function displayProfile(data) {
            // Header
            document.getElementById('profileUsername').textContent = data.username;
            document.getElementById('profileGroup').textContent = data.group || 'Utilisateur';
            
            // Status
            const statusBadge = document.getElementById('statusBadge');
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            if (data.is_active) {
                statusBadge.innerHTML = '<i class="fas fa-check-circle mr-1"></i>Actif';
                statusBadge.className = 'px-3 py-1 bg-green-500/20 text-green-300 rounded-full text-sm';
                statusIndicator.className = 'w-3 h-3 bg-green-500 rounded-full';
                statusText.textContent = 'Compte actif';
            } else {
                statusBadge.innerHTML = '<i class="fas fa-times-circle mr-1"></i>Inactif';
                statusBadge.className = 'px-3 py-1 bg-red-500/20 text-red-300 rounded-full text-sm';
                statusIndicator.className = 'w-3 h-3 bg-red-500 rounded-full';
                statusText.textContent = 'Compte inactif';
            }

            // Profile Picture
            const profilePicture = document.getElementById('profilePicture');
            const defaultAvatar = document.getElementById('defaultAvatar');
            
            if (data.profile_picture) {
                profilePicture.src = data.profile_picture;
                profilePicture.style.display = 'block';
                defaultAvatar.style.display = 'none';
            } else {
                profilePicture.style.display = 'none';
                defaultAvatar.style.display = 'flex';
            }

            // Form Fields
            document.getElementById('usernameInput').value = data.username;
            document.getElementById('userIdInput').value = data.id;
            document.getElementById('groupInput').value = data.group || 'Utilisateur';
        }

        // Toggle Edit Mode
        function toggleEditMode() {
            isEditing = !isEditing;
            const usernameInput = document.getElementById('usernameInput');
            const editBtn = document.getElementById('editProfileBtn');
            const actionButtons = document.getElementById('actionButtons');

            if (isEditing) {
                usernameInput.readOnly = false;
                usernameInput.classList.remove('bg-gray-50', 'dark:bg-gray-700');
                usernameInput.classList.add('bg-white', 'dark:bg-gray-800');
                usernameInput.focus();
                
                editBtn.style.display = 'none';
                actionButtons.style.display = 'flex';
            } else {
                usernameInput.readOnly = true;
                usernameInput.classList.remove('bg-white', 'dark:bg-gray-800');
                usernameInput.classList.add('bg-gray-50', 'dark:bg-gray-700');
                
                editBtn.style.display = 'block';
                actionButtons.style.display = 'none';
                
                // Reset form
                if (currentUserData) {
                    document.getElementById('usernameInput').value = currentUserData.username;
                }
            }
        }

        // Update Profile
        async function updateProfile(formData) {
            try {
                const response = await makeAuthenticatedRequest(`${API_BASE_URL}/auth/profile/update/`, {
                    method: 'PUT',
                    body: formData
                });
                
                if (response && response.ok) {
                    const result = await response.json();
                    showSuccess(result.detail || 'Profil mis à jour avec succès');
                    
                    // Update localStorage if username changed
                    const newUsername = formData.get('username');
                    if (newUsername && newUsername !== currentUserData.username) {
                        localStorage.setItem('username', newUsername);
                    }
                    
                    // Reload profile data
                    await loadProfile();
                    toggleEditMode();
                } else {
                    const errorData = await response.json();
                    showError(errorData.detail || 'Erreur lors de la mise à jour du profil');
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                showError('Erreur lors de la mise à jour du profil');
            }
        }

        // Handle Profile Picture Upload
        async function handleProfilePictureUpload(file) {
            const formData = new FormData();
            formData.append('profile_picture', file);
            
            // Add current username to maintain it
            if (currentUserData) {
                formData.append('username', currentUserData.username);
            }
            
            await updateProfile(formData);
        }

        // Initialize Page
        async function initializePage() {
            if (!checkAuthentication()) return;
            
            document.getElementById('loadingState').classList.remove('hidden');
            
            try {
                await loadProfile();
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
            } catch (error) {
                console.error('Error initializing page:', error);
                showError('Erreur lors de l\'initialisation de la page');
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
        });

        // Back to Dashboard
        document.getElementById('backToDashboard').addEventListener('click', function() {
            window.location.href = 'dashboard.html';
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', function() {
            Swal.fire({
                title: 'Se déconnecter ?',
                text: 'Êtes-vous sûr de vouloir vous déconnecter ?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Oui, déconnectez-moi',
                cancelButtonText: 'Annuler'
            }).then((result) => {
                if (result.isConfirmed) {
                    localStorage.clear();
                    window.location.href = 'login.html';
                }
            });
        });

        // Edit Profile Button
        document.getElementById('editProfileBtn').addEventListener('click', toggleEditMode);

        // Cancel Button
        document.getElementById('cancelBtn').addEventListener('click', function() {
            Swal.fire({
                title: 'Annuler les modifications ?',
                text: 'Les modifications non sauvegardées seront perdues.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Oui, annuler',
                cancelButtonText: 'Continuer l\'édition'
            }).then((result) => {
                if (result.isConfirmed) {
                    toggleEditMode();
                }
            });
        });

        // Profile Form Submit
        document.getElementById('profileForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const newUsername = document.getElementById('usernameInput').value.trim();
            
            if (!newUsername) {
                showError('Le nom d\'utilisateur ne peut pas être vide');
                return;
            }

            if (newUsername === currentUserData.username) {
                showError('Aucune modification détectée');
                return;
            }

            Swal.fire({
                title: 'Confirmer les modifications',
                text: 'Êtes-vous sûr de vouloir modifier votre profil ?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#f97316',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Oui, modifier',
                cancelButtonText: 'Annuler'
            }).then((result) => {
                if (result.isConfirmed) {
                    const formData = new FormData();
                    formData.append('username', newUsername);
                    updateProfile(formData);
                }
            });
        });

        // Profile Picture Upload
        document.getElementById('profilePictureInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Validate file type
                if (!file.type.startsWith('image/')) {
                    showError('Veuillez sélectionner une image valide');
                    return;
                }
                
                // Validate file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    showError('L\'image ne doit pas dépasser 5MB');
                    return;
                }

                Swal.fire({
                    title: 'Changer la photo de profil',
                    text: 'Voulez-vous vraiment changer votre photo de profil ?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#f97316',
                    cancelButtonColor: '#6b7280',
                    confirmButtonText: 'Oui, changer',
                    cancelButtonText: 'Annuler'
                }).then((result) => {
                    if (result.isConfirmed) {
                        handleProfilePictureUpload(file);
                    }
                    // Reset file input
                    e.target.value = '';
                });
            }
        });
    </script>
</body>
</html>