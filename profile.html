<!DOCTYPE html>
<html lang="fr" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil - ERP Génie Civil</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <style>
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes slideIn {
            0% { transform: translateX(-100%); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideInRTL {
            0% { transform: translateX(100%); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .floating { animation: float 6s ease-in-out infinite; }
        .slide-in { animation: slideIn 0.8s ease-out; }
        .slide-in-rtl { animation: slideInRTL 0.8s ease-out; }
        .loading { animation: pulse 1.5s ease-in-out infinite; }
        
        .profile-card-light {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .profile-card-dark {
            background: linear-gradient(135deg, #4c1d95 0%, #581c87 100%);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        
        .theme-transition {
            transition: all 0.3s ease;
        }

        .fa-spin-custom {
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .profile-picture-container {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto;
        }

        .profile-picture {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid rgba(255, 255, 255, 0.3);
        }

        .upload-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            cursor: pointer;
        }

        .profile-picture-container:hover .upload-overlay {
            opacity: 1;
        }

        /* RTL Support */
        [dir="rtl"] .slide-in {
            animation: slideInRTL 0.8s ease-out;
        }

        /* Language Switch Button Styles */
        .language-switch {
            background: linear-gradient(45deg, #f97316, #ea580c);
            border: none;
            border-radius: 8px;
            color: white;
            padding: 8px 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(249, 115, 22, 0.2);
        }

        .language-switch:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(249, 115, 22, 0.3);
        }

        /* Arabic Font */
        [dir="rtl"] {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
    </style>
</head>
<body class="theme-transition min-h-screen bg-gray-50 dark:bg-gray-900">
    <!-- Navigation Bar -->
    <nav class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4 rtl:space-x-reverse">
                    <div class="w-10 h-10 bg-orange-500 rounded-full flex items-center justify-center">
                        <i class="fas fa-user text-white text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-gray-900 dark:text-white font-bold text-xl" data-translate="app-title">ERP Génie Civil</h1>
                        <p class="text-gray-600 dark:text-gray-400 text-sm" data-translate="my-profile">Mon Profil</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4 rtl:space-x-reverse">
                    <!-- Language Switch -->
                    <button id="languageToggle" class="language-switch">
                        <i class="fas fa-language mr-2 rtl:mr-0 rtl:ml-2"></i>
                        <span id="currentLang">العربية</span>
                    </button>
                    
                    <!-- Back to Dashboard -->
                    <button id="backToDashboard" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-all duration-300">
                        <i class="fas fa-arrow-left mr-2 rtl:mr-0 rtl:ml-2 rtl:fa-arrow-right"></i>
                        <span data-translate="dashboard">Tableau de bord</span>
                    </button>
                    
                    <!-- Dark Mode Toggle -->
                    <button id="darkModeToggle" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                        <i id="sunIcon" class="fas fa-sun w-5 h-5 text-gray-600 dark:text-gray-300 hidden dark:block"></i>
                        <i id="moonIcon" class="fas fa-moon w-5 h-5 text-gray-600 dark:text-gray-300 block dark:hidden"></i>
                    </button>
                    
                    <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-all duration-300 transform hover:scale-105">
                        <i class="fas fa-sign-out-alt mr-2 rtl:mr-0 rtl:ml-2"></i>
                        <span data-translate="logout">Déconnexion</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Loading State -->
        <div id="loadingState" class="text-center py-12">
            <i class="fas fa-spinner fa-spin-custom text-orange-500 text-6xl"></i>
            <p class="text-gray-600 dark:text-gray-400 mt-4" data-translate="loading">Chargement du profil...</p>
        </div>

        <!-- Main Content -->
        <div id="mainContent" class="hidden">
            <!-- Profile Header Card -->
            <div class="mb-8 slide-in">
                <div class="profile-card-light dark:profile-card-dark rounded-2xl p-8 text-white shadow-2xl floating">
                    <div class="text-center">
                        <div class="profile-picture-container mb-4">
                            <img id="profilePicture" src="" alt="Photo de profil" class="profile-picture" style="display: none;">
                            <div id="defaultAvatar" class="profile-picture bg-white/20 flex items-center justify-center">
                                <i class="fas fa-user text-6xl text-white/70"></i>
                            </div>
                            <div class="upload-overlay" onclick="document.getElementById('profilePictureInput').click()">
                                <i class="fas fa-camera text-white text-2xl"></i>
                            </div>
                            <input type="file" id="profilePictureInput" accept="image/*" style="display: none;">
                        </div>
                        <h2 class="text-3xl font-bold mb-2" id="profileUsername" data-translate="username">Nom d'utilisateur</h2>
                        <p class="text-white/80 text-lg mb-2" id="profileGroup" data-translate="role">Rôle</p>
                        <div class="flex items-center justify-center space-x-2 rtl:space-x-reverse">
                            <span id="statusBadge" class="px-3 py-1 bg-green-500/20 text-green-300 rounded-full text-sm">
                                <i class="fas fa-check-circle mr-1 rtl:mr-0 rtl:ml-1"></i>
                                <span data-translate="active">Actif</span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Information Card -->
            <div class="slide-in">
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <h3 class="text-2xl font-bold text-gray-900 dark:text-white">
                                <i class="fas fa-user-edit mr-3 rtl:mr-0 rtl:ml-3 text-orange-500"></i>
                                <span data-translate="profile-info">Informations du profil</span>
                            </h3>
                            <button id="editProfileBtn" class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-2 rounded-lg transition-all duration-300 transform hover:scale-105">
                                <i class="fas fa-edit mr-2 rtl:mr-0 rtl:ml-2"></i>
                                <span data-translate="edit">Modifier</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <form id="profileForm">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Username -->
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        <i class="fas fa-user mr-2 rtl:mr-0 rtl:ml-2 text-orange-500"></i>
                                        <span data-translate="username-label">Nom d'utilisateur</span>
                                    </label>
                                    <input type="text" id="usernameInput" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-orange-500 dark:bg-gray-700 dark:text-white bg-gray-50 dark:bg-gray-700" readonly>
                                </div>

                                <!-- User ID (Read-only) -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        <i class="fas fa-id-badge mr-2 rtl:mr-0 rtl:ml-2 text-orange-500"></i>
                                        <span data-translate="user-id">ID Utilisateur</span>
                                    </label>
                                    <input type="text" id="userIdInput" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-white cursor-not-allowed" readonly>
                                </div>

                                <!-- Group (Read-only) -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        <i class="fas fa-users mr-2 rtl:mr-0 rtl:ml-2 text-orange-500"></i>
                                        <span data-translate="role-label">Rôle</span>
                                    </label>
                                    <input type="text" id="groupInput" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-white cursor-not-allowed" readonly>
                                </div>

                                <!-- Status (Read-only) -->
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        <i class="fas fa-toggle-on mr-2 rtl:mr-0 rtl:ml-2 text-orange-500"></i>
                                        <span data-translate="account-status">Statut du compte</span>
                                    </label>
                                    <div class="flex items-center space-x-3 rtl:space-x-reverse">
                                        <span id="statusIndicator" class="w-3 h-3 bg-green-500 rounded-full"></span>
                                        <span id="statusText" class="text-gray-900 dark:text-white" data-translate="account-active">Compte actif</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                                <div class="flex justify-end space-x-4 rtl:space-x-reverse" id="actionButtons" style="display: none;">
                                    <button type="button" id="cancelBtn" class="px-6 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 transition-colors">
                                        <i class="fas fa-times mr-1 rtl:mr-0 rtl:ml-1"></i>
                                        <span data-translate="cancel">Annuler</span>
                                    </button>
                                    <button type="submit" class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-2 rounded-lg transition-all duration-300 transform hover:scale-105">
                                        <i class="fas fa-save mr-2 rtl:mr-0 rtl:ml-2"></i>
                                        <span data-translate="save">Enregistrer les modifications</span>
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Toast -->
    <div id="errorToast" class="fixed top-4 right-4 rtl:right-auto rtl:left-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg hidden z-50">
        <div class="flex items-center">
            <i class="fas fa-exclamation-circle mr-2 rtl:mr-0 rtl:ml-2"></i>
            <span id="errorMessage" data-translate="generic-error">Une erreur s'est produite</span>
        </div>
    </div>

    <!-- Success Toast -->
    <div id="successToast" class="fixed top-4 right-4 rtl:right-auto rtl:left-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg hidden z-50">
        <div class="flex items-center">
            <i class="fas fa-check-circle mr-2 rtl:mr-0 rtl:ml-2"></i>
            <span id="successMessage" data-translate="operation-success">Opération réussie</span>
        </div>
    </div>

    <script>
        // Language Translations
        const translations = {
            fr: {
                'app-title': 'ERP Génie Civil',
                'my-profile': 'Mon Profil',
                'dashboard': 'Tableau de bord',
                'logout': 'Déconnexion',
                'loading': 'Chargement du profil...',
                'username': 'Nom d\'utilisateur',
                'role': 'Rôle',
                'active': 'Actif',
                'inactive': 'Inactif',
                'profile-info': 'Informations du profil',
                'edit': 'Modifier',
                'username-label': 'Nom d\'utilisateur',
                'user-id': 'ID Utilisateur',
                'role-label': 'Rôle',
                'account-status': 'Statut du compte',
                'account-active': 'Compte actif',
                'account-inactive': 'Compte inactif',
                'cancel': 'Annuler',
                'save': 'Enregistrer les modifications',
                'generic-error': 'Une erreur s\'est produite',
                'operation-success': 'Opération réussie',
                'logout-confirm-title': 'Se déconnecter ?',
                'logout-confirm-text': 'Êtes-vous sûr de vouloir vous déconnecter ?',
                'cancel-changes-title': 'Annuler les modifications ?',
                'cancel-changes-text': 'Les modifications non sauvegardées seront perdues.',
                'confirm-changes-title': 'Confirmer les modifications',
                'confirm-changes-text': 'Êtes-vous sûr de vouloir modifier votre profil ?',
                'change-photo-title': 'Changer la photo de profil',
                'change-photo-text': 'Voulez-vous vraiment changer votre photo de profil ?',
                'yes-logout': 'Oui, déconnectez-moi',
                'yes-cancel': 'Oui, annuler',
                'yes-modify': 'Oui, modifier',
                'yes-change': 'Oui, changer',
                'continue-editing': 'Continuer l\'édition',
                'username-empty-error': 'Le nom d\'utilisateur ne peut pas être vide',
                'no-changes-error': 'Aucune modification détectée',
                'invalid-image-error': 'Veuillez sélectionner une image valide',
                'image-size-error': 'L\'image ne doit pas dépasser 5MB',
                'profile-load-error': 'Erreur lors du chargement du profil',
                'profile-update-error': 'Erreur lors de la mise à jour du profil',
                'profile-update-success': 'Profil mis à jour avec succès',
                'page-init-error': 'Erreur lors de l\'initialisation de la page'
            },
            ar: {
                'app-title': 'نظام تخطيط موارد المؤسسة - الهندسة المدنية',
                'my-profile': 'ملفي الشخصي',
                'dashboard': 'لوحة التحكم',
                'logout': 'تسجيل الخروج',
                'loading': 'جاري تحميل الملف الشخصي...',
                'username': 'اسم المستخدم',
                'role': 'الدور',
                'active': 'نشط',
                'inactive': 'غير نشط',
                'profile-info': 'معلومات الملف الشخصي',
                'edit': 'تعديل',
                'username-label': 'اسم المستخدم',
                'user-id': 'معرف المستخدم',
                'role-label': 'الدور',
                'account-status': 'حالة الحساب',
                'account-active': 'حساب نشط',
                'account-inactive': 'حساب غير نشط',
                'cancel': 'إلغاء',
                'save': 'حفظ التغييرات',
                'generic-error': 'حدث خطأ',
                'operation-success': 'تمت العملية بنجاح',
                'logout-confirm-title': 'تسجيل الخروج؟',
                'logout-confirm-text': 'هل أنت متأكد من أنك تريد تسجيل الخروج؟',
                'cancel-changes-title': 'إلغاء التغييرات؟',
                'cancel-changes-text': 'ستفقد التغييرات غير المحفوظة.',
                'confirm-changes-title': 'تأكيد التغييرات',
                'confirm-changes-text': 'هل أنت متأكد من أنك تريد تعديل ملفك الشخصي؟',
                'change-photo-title': 'تغيير صورة الملف الشخصي',
                'change-photo-text': 'هل تريد حقاً تغيير صورة ملفك الشخصي؟',
                'yes-logout': 'نعم، سجل خروجي',
                'yes-cancel': 'نعم، إلغاء',
                'yes-modify': 'نعم، تعديل',
                'yes-change': 'نعم، تغيير',
                'continue-editing': 'متابعة التعديل',
                'username-empty-error': 'لا يمكن أن يكون اسم المستخدم فارغاً',
                'no-changes-error': 'لم يتم اكتشاف أي تغييرات',
                'invalid-image-error': 'يرجى اختيار صورة صالحة',
                'image-size-error': 'يجب ألا تتجاوز الصورة 5 ميجابايت',
                'profile-load-error': 'خطأ في تحميل الملف الشخصي',
                'profile-update-error': 'خطأ في تحديث الملف الشخصي',
                'profile-update-success': 'تم تحديث الملف الشخصي بنجاح',
                'page-init-error': 'خطأ في تهيئة الصفحة'
            }
        };

        // Language Management
        let currentLanguage = localStorage.getItem('language') || 'fr';

        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('language', lang);
            
            const html = document.documentElement;
            html.setAttribute('lang', lang);
            html.setAttribute('dir', lang === 'ar' ? 'rtl' : 'ltr');
            
            // Update language button text
            document.getElementById('currentLang').textContent = lang === 'fr' ? 'العربية' : 'Français';
            
            // Update all translatable elements
            document.querySelectorAll('[data-translate]').forEach(element => {
                const key = element.getAttribute('data-translate');
                if (translations[lang] && translations[lang][key]) {
                    element.textContent = translations[lang][key];
                }
            });

            // Update title
            document.title = lang === 'fr' ? 'Profil - ERP Génie Civil' : 'الملف الشخصي - نظام تخطيط موارد المؤسسة';
        }

        function translate(key) {
            return translations[currentLanguage] && translations[currentLanguage][key] 
                ? translations[currentLanguage][key] 
                : key;
        }

        // Dark Mode Toggle
        const darkModeToggle = document.getElementById('darkModeToggle');
        const html = document.documentElement;

        const currentTheme = localStorage.getItem('theme') || 'light';
        if (currentTheme === 'dark') {
            html.classList.add('dark');
        }

        darkModeToggle.addEventListener('click', function() {
            html.classList.toggle('dark');
            
            if (html.classList.contains('dark')) {
                localStorage.setItem('theme', 'dark');
            } else {
                localStorage.setItem('theme', 'light');
            }
        });

        // Language Toggle
        document.getElementById('languageToggle').addEventListener('click', function() {
            setLanguage(currentLanguage === 'fr' ? 'ar' : 'fr');
        });

        // API Configuration
        const API_BASE_URL = 'http://127.0.0.1:8000';
        let isEditing = false;
        let currentUserData = null;

        // Utility Functions
        function showError(message) {
            const errorToast = document.getElementById('errorToast');
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            errorToast.classList.remove('hidden');
            setTimeout(() => {
                errorToast.classList.add('hidden');
            }, 5000);
        }

        function showSuccess(message) {
            const successToast = document.getElementById('successToast');
            const successMessage = document.getElementById('successMessage');
            successMessage.textContent = message;
            successToast.classList.remove('hidden');
            setTimeout(() => {
                successToast.classList.add('hidden');
            }, 3000);
        }

        async function makeAuthenticatedRequest(url, options = {}) {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = 'login.html';
                return null;
            }
            
            const defaultOptions = {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    ...options.headers
                }
            };
            
            const response = await fetch(url, { ...options, ...defaultOptions });
            
            if (response.status === 401) {
                localStorage.clear();
                window.location.href = 'login.html';
                return null;
            }
            
            return response;
        }

        function checkAuthentication() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        // Load Profile Data
        async function loadProfile() {
            try {
                const response = await makeAuthenticatedRequest(`${API_BASE_URL}/auth/profile/`);
                if (response && response.ok) {
                    currentUserData = await response.json();
                    displayProfile(currentUserData);
                } else {
                    showError(translate('profile-load-error'));
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                showError(translate('profile-load-error'));
            }
        }

        // Display Profile Data
        function displayProfile(data) {
            // Header
            document.getElementById('profileUsername').textContent = data.username;
            document.getElementById('profileGroup').textContent = data.group || translate('role');
            
            // Status
            const statusBadge = document.getElementById('statusBadge');
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            if (data.is_active) {
                statusBadge.innerHTML = `<i class="fas fa-check-circle mr-1 rtl:mr-0 rtl:ml-1"></i><span>${translate('active')}</span>`;
                statusBadge.className = 'px-3 py-1 bg-green-500/20 text-green-300 rounded-full text-sm';
                statusIndicator.className = 'w-3 h-3 bg-green-500 rounded-full';
                statusText.textContent = translate('account-active');
            } else {
                statusBadge.innerHTML = `<i class="fas fa-times-circle mr-1 rtl:mr-0 rtl:ml-1"></i><span>${translate('inactive')}</span>`;
                statusBadge.className = 'px-3 py-1 bg-red-500/20 text-red-300 rounded-full text-sm';
                statusIndicator.className = 'w-3 h-3 bg-red-500 rounded-full';
                statusText.textContent = translate('account-inactive');
            }

            // Profile Picture
            const profilePicture = document.getElementById('profilePicture');
            const defaultAvatar = document.getElementById('defaultAvatar');
            
            if (data.profile_picture) {
                profilePicture.src = data.profile_picture;
                profilePicture.style.display = 'block';
                defaultAvatar.style.display = 'none';
            } else {
                profilePicture.style.display = 'none';
                defaultAvatar.style.display = 'flex';
            }

            // Form Fields
            document.getElementById('usernameInput').value = data.username;
            document.getElementById('userIdInput').value = data.id;
            document.getElementById('groupInput').value = data.group || translate('role');
        }

        // Toggle Edit Mode
        function toggleEditMode() {
            isEditing = !isEditing;
            const usernameInput = document.getElementById('usernameInput');
            const editBtn = document.getElementById('editProfileBtn');
            const actionButtons = document.getElementById('actionButtons');

            if (isEditing) {
                usernameInput.readOnly = false;
                usernameInput.classList.remove('bg-gray-50', 'dark:bg-gray-700');
                usernameInput.classList.add('bg-white', 'dark:bg-gray-800');
                usernameInput.focus();
                
                editBtn.style.display = 'none';
                actionButtons.style.display = 'flex';
            } else {
                usernameInput.readOnly = true;
                usernameInput.classList.remove('bg-white', 'dark:bg-gray-800');
                usernameInput.classList.add('bg-gray-50', 'dark:bg-gray-700');
                
                editBtn.style.display = 'block';
                actionButtons.style.display = 'none';
                
                // Reset form
                if (currentUserData) {
                    document.getElementById('usernameInput').value = currentUserData.username;
                }
            }
        }

        // Update Profile
        async function updateProfile(formData) {
            try {
                const response = await makeAuthenticatedRequest(`${API_BASE_URL}/auth/profile/update/`, {
                    method: 'PUT',
                    body: formData
                });
                
                if (response && response.ok) {
                    const result = await response.json();
                    showSuccess(result.detail || translate('profile-update-success'));
                    
                    // Update localStorage if username changed
                    const newUsername = formData.get('username');
                    if (newUsername && newUsername !== currentUserData.username) {
                        localStorage.setItem('username', newUsername);
                    }
                    
                    // Reload profile data
                    await loadProfile();
                    toggleEditMode();
                } else {
                    const errorData = await response.json();
                    showError(errorData.detail || translate('profile-update-error'));
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                showError(translate('profile-update-error'));
            }
        }

        // Handle Profile Picture Upload
        async function handleProfilePictureUpload(file) {
            const formData = new FormData();
            formData.append('profile_picture', file);
            
            // Add current username to maintain it
            if (currentUserData) {
                formData.append('username', currentUserData.username);
            }
            
            await updateProfile(formData);
        }

        // Initialize Page
        async function initializePage() {
            if (!checkAuthentication()) return;
            
            // Set initial language
            setLanguage(currentLanguage);
            
            document.getElementById('loadingState').classList.remove('hidden');
            
            try {
                await loadProfile();
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
            } catch (error) {
                console.error('Error initializing page:', error);
                showError(translate('page-init-error'));
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
        });

        // Back to Dashboard
        document.getElementById('backToDashboard').addEventListener('click', function() {
            window.location.href = 'dashboard.html';
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', function() {
            Swal.fire({
                title: translate('logout-confirm-title'),
                text: translate('logout-confirm-text'),
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: translate('yes-logout'),
                cancelButtonText: translate('cancel')
            }).then((result) => {
                if (result.isConfirmed) {
                    localStorage.clear();
                    window.location.href = 'login.html';
                }
            });
        });

        // Edit Profile Button
        document.getElementById('editProfileBtn').addEventListener('click', toggleEditMode);

        // Cancel Button
        document.getElementById('cancelBtn').addEventListener('click', function() {
            Swal.fire({
                title: translate('cancel-changes-title'),
                text: translate('cancel-changes-text'),
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6b7280',
                confirmButtonText: translate('yes-cancel'),
                cancelButtonText: translate('continue-editing')
            }).then((result) => {
                if (result.isConfirmed) {
                    toggleEditMode();
                }
            });
        });

        // Profile Form Submit
        document.getElementById('profileForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const newUsername = document.getElementById('usernameInput').value.trim();
            
            if (!newUsername) {
                showError(translate('username-empty-error'));
                return;
            }

            if (newUsername === currentUserData.username) {
                showError(translate('no-changes-error'));
                return;
            }

            Swal.fire({
                title: translate('confirm-changes-title'),
                text: translate('confirm-changes-text'),
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#f97316',
                cancelButtonColor: '#6b7280',
                confirmButtonText: translate('yes-modify'),
                cancelButtonText: translate('cancel')
            }).then((result) => {
                if (result.isConfirmed) {
                    const formData = new FormData();
                    formData.append('username', newUsername);
                    updateProfile(formData);
                }
            });
        });

        // Profile Picture Upload
        document.getElementById('profilePictureInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Validate file type
                if (!file.type.startsWith('image/')) {
                    showError(translate('invalid-image-error'));
                    return;
                }
                
                // Validate file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    showError(translate('image-size-error'));
                    return;
                }

                Swal.fire({
                    title: translate('change-photo-title'),
                    text: translate('change-photo-text'),
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#f97316',
                    cancelButtonColor: '#6b7280',
                    confirmButtonText: translate('yes-change'),
                    cancelButtonText: translate('cancel')
                }).then((result) => {
                    if (result.isConfirmed) {
                        handleProfilePictureUpload(file);
                    }
                    // Reset file input
                    e.target.value = '';
                });
            }
        });
    </script>
</body>
</html>