<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Détail Bon de Livraison - ERP Génie Civil</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <style>
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes slideIn {
            0% { transform: translateX(-100%); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .floating { animation: float 6s ease-in-out infinite; }
        .slide-in { animation: slideIn 0.8s ease-out; }
        .loading { animation: pulse 1.5s ease-in-out infinite; }
        
        .theme-transition {
            transition: all 0.3s ease;
        }

        .fa-spin-custom {
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .detail-card {
            @apply bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-6 shadow-sm;
        }

        .detail-label {
            @apply text-sm font-medium text-gray-500 dark:text-gray-400 mb-1;
        }

        .detail-value {
            @apply text-gray-900 dark:text-white font-semibold;
        }

        .status-badge {
            @apply px-3 py-1 rounded-full text-sm font-medium;
        }

        .payment-cash {
            @apply bg-green-100 dark:bg-green-900 text-green-600 dark:text-green-300 border border-green-200 dark:border-green-800;
        }

        .payment-transfer {
            @apply bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 border border-blue-200 dark:border-blue-800;
        }

        .payment-check {
            @apply bg-purple-100 dark:bg-purple-900 text-purple-600 dark:text-purple-300 border border-purple-200 dark:border-purple-800;
        }

        .pdf-status-yes {
            @apply bg-green-100 dark:bg-green-900 text-green-600 dark:text-green-300 border border-green-200 dark:border-green-800;
        }

        .pdf-status-no {
            @apply bg-gray-100 dark:bg-gray-900 text-gray-600 dark:text-gray-300 border border-gray-200 dark:border-gray-800;
        }
    </style>
</head>
<body class="theme-transition min-h-screen bg-gray-50 dark:bg-gray-900">
    <nav class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <button id="backBtn" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                        <i class="fas fa-arrow-left text-gray-600 dark:text-gray-300"></i>
                    </button>
                    <div class="w-10 h-10 bg-orange-500 rounded-full flex items-center justify-center">
                        <i class="fas fa-truck text-white text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-gray-900 dark:text-white font-bold text-xl">ERP Génie Civil</h1>
                        <p class="text-gray-600 dark:text-gray-400 text-sm">Détail Bon de Livraison</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <button id="darkModeToggle" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                        <i id="sunIcon" class="fas fa-sun w-5 h-5 text-gray-600 dark:text-gray-300 hidden dark:block"></i>
                        <i id="moonIcon" class="fas fa-moon w-5 h-5 text-gray-600 dark:text-gray-300 block dark:hidden"></i>
                    </button>
                    
                    <button id="profileBtn" class="flex items-center space-x-2 p-2 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-all duration-300 transform hover:scale-105">
                        <i class="fas fa-user text-gray-600 dark:text-gray-300"></i>
                        <span class="text-gray-600 dark:text-gray-300 text-sm font-medium">Profil</span>
                    </button>
                    
                    <div class="text-gray-900 dark:text-white text-right">
                        <p class="font-medium" id="welcomeUser">Bienvenue</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400" id="userRole">Chargement...</p>
                    </div>
                    
                    <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-all duration-300 transform hover:scale-105">
                        <i class="fas fa-sign-out-alt mr-2"></i>Déconnexion
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div id="loadingState" class="text-center py-12">
            <i class="fas fa-spinner fa-spin-custom text-orange-500 text-6xl"></i>
            <p class="text-gray-600 dark:text-gray-400 mt-4">Chargement des détails...</p>
        </div>

        <div id="mainContent" class="hidden">
            <div class="slide-in">
                <div class="detail-card mb-8">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center space-x-4">
                            <div class="w-16 h-16 bg-orange-500 rounded-xl flex items-center justify-center">
                                <i class="fas fa-truck text-white text-2xl"></i>
                            </div>
                            <div>
                                <h2 class="text-gray-900 dark:text-white text-2xl font-bold" id="blNumber">BL #</h2>
                                <p class="text-gray-600 dark:text-gray-400" id="projectName">Projet</p>
                            </div>
                        </div>
                        <div class="flex space-x-3">
                            <button id="deleteBonBtn" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg transition-all duration-300 transform hover:scale-105">
                                <i class="fas fa-trash mr-2"></i>Supprimer
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                        <div>
                            <p class="detail-label">
                                <i class="fas fa-dollar-sign mr-1"></i>Montant Total
                            </p>
                            <p class="detail-value text-2xl text-green-600 dark:text-green-400" id="totalAmount">0.00 DZD</p>
                        </div>
                        <div>
                            <p class="detail-label">
                                <i class="fas fa-credit-card mr-1"></i>Méthode de Paiement
                            </p>
                            <span id="paymentMethod" class="status-badge">Cash</span>
                        </div>
                        <div>
                            <p class="detail-label">
                                <i class="fas fa-file-pdf mr-1"></i>PDF Généré
                            </p>
                            <span id="pdfStatus" class="status-badge">Non</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <p class="detail-label">
                                <i class="fas fa-map-marker-alt mr-1"></i>Adresse d'Origine
                            </p>
                            <p class="detail-value" id="originAddress">-</p>
                        </div>
                        <div>
                            <p class="detail-label">
                                <i class="fas fa-map-pin mr-1"></i>Adresse de Destination
                            </p>
                            <p class="detail-value" id="destinationAddress">-</p>
                        </div>
                    </div>

                    <div class="mb-6">
                        <p class="detail-label">
                            <i class="fas fa-align-left mr-1"></i>Description
                        </p>
                        <p class="detail-value" id="description">-</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <p class="detail-label">
                                <i class="fas fa-user mr-1"></i>Créé par
                            </p>
                            <p class="detail-value" id="createdBy">-</p>
                        </div>
                        <div>
                            <p class="detail-label">
                                <i class="fas fa-calendar mr-1"></i>Date de Création
                            </p>
                            <p class="detail-value" id="createdAt">-</p>
                        </div>
                    </div>

                    <div id="pdfGeneratedSection" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6 hidden">
                        <div>
                            <p class="detail-label">
                                <i class="fas fa-user-cog mr-1"></i>PDF Généré par
                            </p>
                            <p class="detail-value" id="pdfGeneratedBy">-</p>
                        </div>
                        <div>
                            <p class="detail-label">
                                <i class="fas fa-calendar-check mr-1"></i>Date de Génération PDF
                            </p>
                            <p class="detail-value" id="pdfGeneratedAt">-</p>
                        </div>
                    </div>

                    <div id="paymentProofSection" class="mb-6 hidden">
                        <p class="detail-label">
                            <i class="fas fa-receipt mr-1"></i>Preuve de Paiement
                        </p>
                        <a id="paymentProofLink" href="#" target="_blank" class="inline-flex items-center text-blue-600 dark:text-blue-400 hover:underline">
                            <i class="fas fa-external-link-alt mr-2"></i>Voir le fichier
                        </a>
                    </div>
                </div>

                <div class="detail-card mb-8">
                    <h3 class="text-gray-900 dark:text-white text-xl font-bold mb-6">
                        <i class="fas fa-box mr-2 text-orange-500"></i>Articles
                    </h3>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-200 dark:border-gray-700">
                                    <th class="text-left py-3 px-4 text-gray-600 dark:text-gray-400 font-medium">Produit</th>
                                    <th class="text-right py-3 px-4 text-gray-600 dark:text-gray-400 font-medium">Quantité</th>
                                    <th class="text-right py-3 px-4 text-gray-600 dark:text-gray-400 font-medium">Prix Unitaire</th>
                                    <th class="text-right py-3 px-4 text-gray-600 dark:text-gray-400 font-medium">Total</th>
                                </tr>
                            </thead>
                            <tbody id="itemsList">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="chargesSection" class="detail-card hidden">
                    <h3 class="text-gray-900 dark:text-white text-xl font-bold mb-6">
                        <i class="fas fa-plus-circle mr-2 text-orange-500"></i>Frais Supplémentaires
                    </h3>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-200 dark:border-gray-700">
                                    <th class="text-left py-3 px-4 text-gray-600 dark:text-gray-400 font-medium">Description</th>
                                    <th class="text-right py-3 px-4 text-gray-600 dark:text-gray-400 font-medium">Montant</th>
                                </tr>
                            </thead>
                            <tbody id="chargesList">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="errorToast" class="fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg hidden z-50">
        <div class="flex items-center">
            <i class="fas fa-exclamation-circle mr-2"></i>
            <span id="errorMessage">Une erreur s'est produite</span>
        </div>
    </div>

    <div id="successToast" class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg hidden z-50">
        <div class="flex items-center">
            <i class="fas fa-check-circle mr-2"></i>
            <span id="successMessage">Opération réussie</span>
        </div>
    </div>

    <script>
        const darkModeToggle = document.getElementById('darkModeToggle');
        const html = document.documentElement;

        const currentTheme = localStorage.getItem('theme') || 'light';
        if (currentTheme === 'dark') {
            html.classList.add('dark');
        }

        darkModeToggle.addEventListener('click', function() {
            html.classList.toggle('dark');
            
            if (html.classList.contains('dark')) {
                localStorage.setItem('theme', 'dark');
            } else {
                localStorage.setItem('theme', 'light');
            }
        });

        const API_BASE_URL = 'http://127.0.0.1:8000';
        let bonData = null;

        function getBonIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('bon_id');
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('fr-FR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('fr-FR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showError(message) {
            const errorToast = document.getElementById('errorToast');
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            errorToast.classList.remove('hidden');
            setTimeout(() => {
                errorToast.classList.add('hidden');
            }, 5000);
        }

        function showSuccess(message) {
            const successToast = document.getElementById('successToast');
            const successMessage = document.getElementById('successMessage');
            successMessage.textContent = message;
            successToast.classList.remove('hidden');
            setTimeout(() => {
                successToast.classList.add('hidden');
            }, 3000);
        }

        async function makeAuthenticatedRequest(url, options = {}) {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = 'login.html';
                return null;
            }
            
            const defaultOptions = {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            };
            
            const response = await fetch(url, { ...options, ...defaultOptions });
            
            if (response.status === 401) {
                localStorage.clear();
                window.location.href = 'login.html';
                return null;
            }
            
            return response;
        }

        function checkAuthentication() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        async function loadUserProfile() {
            const username = localStorage.getItem('username');
            const groups = localStorage.getItem('user_groups');
            
            if (username) {
                document.getElementById('welcomeUser').textContent = `Bienvenue, ${username}`;
                if (groups) {
                    try {
                        const groupsArray = JSON.parse(groups);
                        document.getElementById('userRole').textContent = groupsArray.length > 0 ? groupsArray[0] : 'Utilisateur';
                    } catch (e) {
                        document.getElementById('userRole').textContent = 'Utilisateur';
                    }
                }
            }
            
            try {
                const response = await makeAuthenticatedRequest(`${API_BASE_URL}/auth/profile/`);
                if (response && response.ok) {
                    const data = await response.json();
                    document.getElementById('welcomeUser').textContent = `Bienvenue, ${data.username}`;
                    document.getElementById('userRole').textContent = data.group || 'Utilisateur';
                }
            } catch (error) {
                console.log('Could not load profile:', error.message);
            }
        }

        async function loadBonDetails(bonId) {
            try {
                const response = await makeAuthenticatedRequest(`${API_BASE_URL}/gestion/api/bon-de-livraison/${bonId}/`);
                if (response && response.ok) {
                    bonData = await response.json();
                    displayBonDetails(bonData);
                } else {
                    showError('Erreur lors du chargement des détails du bon');
                }
            } catch (error) {
                console.error('Error loading bon details:', error);
                showError('Erreur lors du chargement des détails du bon');
            }
        }

        function displayBonDetails(data) {
            document.getElementById('blNumber').textContent = `BL #${data.bl_number}`;
            document.getElementById('projectName').textContent = data.project_name;
            document.getElementById('totalAmount').textContent = `${formatCurrency(data.total_amount)} DZD`;
            document.getElementById('originAddress').textContent = data.origin_address || '-';
            document.getElementById('destinationAddress').textContent = data.destination_address || '-';
            document.getElementById('description').textContent = data.description || '-';
            document.getElementById('createdAt').textContent = formatDate(data.created_at);

            if (data.created_by) {
                document.getElementById('createdBy').textContent = data.created_by.full_name || data.created_by.username;
            }

            const paymentMethodElement = document.getElementById('paymentMethod');
            paymentMethodElement.textContent = data.payment_method;
            paymentMethodElement.className = 'status-badge ';
            switch (data.payment_method) {
                case 'cash':
                    paymentMethodElement.className += 'payment-cash';
                    paymentMethodElement.innerHTML = '<i class="fas fa-money-bill mr-1"></i>Espèces';
                    break;
                case 'transfer':
                    paymentMethodElement.className += 'payment-transfer';
                    paymentMethodElement.innerHTML = '<i class="fas fa-university mr-1"></i>Virement';
                    break;
                case 'check':
                    paymentMethodElement.className += 'payment-check';
                    paymentMethodElement.innerHTML = '<i class="fas fa-check mr-1"></i>Chèque';
                    break;
            }

            const pdfStatusElement = document.getElementById('pdfStatus');
            pdfStatusElement.className = 'status-badge ';
            if (data.has_pdf) {
                pdfStatusElement.className += 'pdf-status-yes';
                pdfStatusElement.innerHTML = '<i class="fas fa-check mr-1"></i>Oui';
                
                if (data.pdf_generated_by) {
                    document.getElementById('pdfGeneratedBy').textContent = data.pdf_generated_by.full_name || data.pdf_generated_by.username;
                    document.getElementById('pdfGeneratedAt').textContent = formatDate(data.pdf_generated_at);
                    document.getElementById('pdfGeneratedSection').classList.remove('hidden');
                }
            } else {
                pdfStatusElement.className += 'pdf-status-no';
                pdfStatusElement.innerHTML = '<i class="fas fa-times mr-1"></i>Non';
            }

            if (data.payment_proof) {
                document.getElementById('paymentProofLink').href = data.payment_proof;
                document.getElementById('paymentProofSection').classList.remove('hidden');
            }

            const itemsList = document.getElementById('itemsList');
            itemsList.innerHTML = '';
            data.items.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-100 dark:border-gray-700';
                row.innerHTML = `
                    <td class="py-3 px-4 text-gray-900 dark:text-white">${item.product_name}</td>
                    <td class="py-3 px-4 text-right text-gray-900 dark:text-white">${item.quantity}</td>
                    <td class="py-3 px-4 text-right text-gray-900 dark:text-white">${formatCurrency(item.unit_price)} DZD</td>
                    <td class="py-3 px-4 text-right text-green-600 dark:text-green-400 font-semibold">${formatCurrency(item.total_price)} DZD</td>
                `;
                itemsList.appendChild(row);
            });

            if (data.additional_charges && data.additional_charges.length > 0) {
                const chargesList = document.getElementById('chargesList');
                chargesList.innerHTML = '';
                data.additional_charges.forEach(charge => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-100 dark:border-gray-700';
                    row.innerHTML = `
                        <td class="py-3 px-4 text-gray-900 dark:text-white">${charge.description}</td>
                        <td class="py-3 px-4 text-right text-orange-600 dark:text-orange-400 font-semibold">${formatCurrency(charge.amount)} DZD</td>
                    `;
                    chargesList.appendChild(row);
                });
                document.getElementById('chargesSection').classList.remove('hidden');
            }
        }

        async function deleteBon(bonId) {
            try {
                const response = await makeAuthenticatedRequest(`${API_BASE_URL}/gestion/api/bon-de-livraison/${bonId}/delete/`, {
                    method: 'DELETE'
                });
                
                if (response && response.status === 204) {
                    showSuccess('Bon de livraison supprimé avec succès');
                    setTimeout(() => {
                        window.history.back();
                    }, 1500);
                } else {
                    showError('Erreur lors de la suppression du bon');
                }
            } catch (error) {
                console.error('Error deleting bon:', error);
                showError('Erreur lors de la suppression du bon');
            }
        }

        async function initializePage() {
            if (!checkAuthentication()) return;
            
            const bonId = getBonIdFromURL();
            if (!bonId) {
                showError('ID du bon de livraison manquant');
                return;
            }
            
            document.getElementById('loadingState').classList.remove('hidden');
            
            try {
                await Promise.all([
                    loadUserProfile(),
                    loadBonDetails(bonId)
                ]);
                
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
            } catch (error) {
                console.error('Error initializing page:', error);
                showError('Erreur lors de l\'initialisation de la page');
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
        });

        document.getElementById('logoutBtn').addEventListener('click', function() {
            Swal.fire({
                title: 'Se déconnecter ?',
                text: 'Êtes-vous sûr de vouloir vous déconnecter ?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Oui, déconnectez-moi',
                cancelButtonText: 'Annuler'
            }).then((result) => {
                if (result.isConfirmed) {
                    localStorage.clear();
                    window.location.href = 'login.html';
                }
            });
        });

        document.getElementById('backBtn').addEventListener('click', function() {
            window.history.back();
        });

        document.getElementById('profileBtn').addEventListener('click', function() {
            window.location.href = 'profile.html';
        });

        document.getElementById('deleteBonBtn').addEventListener('click', function() {
            if (!bonData) return;
            
            Swal.fire({
                title: 'Supprimer le bon de livraison ?',
                text: `Êtes-vous sûr de vouloir supprimer le bon ${bonData.bl_number} ? Cette action est irréversible.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Oui, supprimer',
                cancelButtonText: 'Annuler'
            }).then((result) => {
                if (result.isConfirmed) {
                    deleteBon(bonData.id);
                }
            });
        });
    </script>
    
</body>
</html>